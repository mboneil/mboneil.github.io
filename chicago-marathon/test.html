<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
      #legend {
        background: white;
        padding: 10px;
        margin-right: 20px;
        width: 25%;
        min-width: 200px;
      }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js">
    </script>
    <script type="text/javascript">
      var map = null;                 // need map to be global variable so declare it outside of initialize function
      var routeSegments = [];         // this stores each route segement object, this is how we change segment widths
      var segmentWidthVariance = 8;   // this determines the range in size the route segments can have

      // so the map looks unique
      // to create your own: http://gmaps-samples-v3.googlecode.com/svn/trunk/styledmaps/wizard/index.html
      var mapStyles = [
        {
          "featureType": "water",
          "stylers": [
            { "visibility": "on" },
            { "color": "#1822da" },
            { "lightness": 54 }
          ]
        },{
          "featureType": "administrative",
          "stylers": [
            { "color": "#808080" },
            { "lightness": -38 },
            { "visibility": "off" }
          ]
        },{
          "featureType": "road.local",
          "elementType": "geometry",
          "stylers": [
            { "lightness": -63 },
            { "color": "#be8080" },
            { "visibility": "on" }
          ]
        },{
          "featureType": "road.highway",
          "elementType": "geometry",
          "stylers": [
            { "visibility": "simplified" },
            { "color": "#c18080" },
            { "lightness": 61 }
          ]
        },{
          "featureType": "landscape",
          "stylers": [
            { "visibility": "on" },
            { "color": "#79a3f9" },
            { "lightness": 74 }
          ]
        },{
        }
      ];

      // source: http://codepen.io/KryptoniteDove/blog/load-json-file-locally-using-pure-javascript
      function loadJSON(callback) {   
        var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
        xobj.open('GET', '/route.json', true); // Path to json file is HARDCODED!!!!
        xobj.onreadystatechange = function () {
              if (xobj.readyState == 4 && xobj.status == "200") {
                // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                callback(xobj.responseText);
              }
        };
        xobj.send(null);  
      }

      // updates size of all route segments randomly
      function changeRouteWidths() {
        for (var i=0; i < routeSegments.length; i++) {
          routeSegments[i].setOptions({
            strokeWeight: Math.random()*segmentWidthVariance + 1
          });
        }
      }

      // creates map and loads course data
      function initialize() {
        var mapOptions = {
          center: { lat: 41.875696, lng: -87.624207}, // Chicago
          zoom: 12
        };
        map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);

        // !!!! TODO enable this to add custom map styles
        //map.setOptions({styles: mapStyles});

        // add legend to upper right of map
        map.controls[google.maps.ControlPosition.RIGHT_TOP].push(
          document.getElementById('legend'));


        // load the course data and draw it on the map
        loadJSON(function(response) {
            // Parse JSON string into object
            var route = JSON.parse(response);

            // loop through, create segments and draw them
            for (var i=0; i < route.length; i++) {
              var segmentCoordinates = [
                new google.maps.LatLng(route[i]['start']['lat'], route[i]['start']['long']),
                new google.maps.LatLng(route[i]['end']['lat'], route[i]['end']['long'])
              ];

              routeSegments[i] = new google.maps.Polyline({
                path: segmentCoordinates,
                geodesic: true,
                strokeColor: '#FF0000',           // decides teh color of this segment of the route
                strokeOpacity: 1.0,
                // as a test randomly vary the segment line thickness
                strokeWeight: Math.random()*segmentWidthVariance + 2 // decides the width of this segment of the route
              });

              // this adds the segment to the map, making it visible
              routeSegments[i].setMap(map);
            }

            // set it so route segments will change widths every three seconds to emulate changing race conditions
            setInterval(changeRouteWidths, 3000);
         });

        // Don't need old overlay anymore. Using Polylines now for more control
        //
        // var ctaLayer = new google.maps.KmlLayer({
        //   url: 'http://caleb-young.com/mbdataviz/Course_Map.kml'
        // });
        // ctaLayer.setMap(map);

        // google.maps.event.addListener(ctaLayer, 'click', function(e) {
        //   console.log(e);
        // });

      }

      // load map once window is loaded
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
<div id="map-canvas"></div>
<div id="legend">
  <h2>Chicago Marathon</h2>
  <p>Kitty ipsum dolor sit amet, biting sleep in the sink litter box pharetra consectetur, enim ut nibh elit tincidunt a sleep in the sink. Tincidunt a tail flick jump on the table egestas consectetur, accumsan sleep in the sink scratched sagittis et aliquam eat. Rutrum enim ut elit enim feed me, orci turpis bibendum quis nunc I don't like that food iaculis nullam vehicula. Sniff vel sniff orci turpis, eat the grass sagittis knock over the lamp tincidunt a sagittis sunbathe. I don't like that food vehicula suscipit run tail flick, zzz aliquam enim ut rhoncus tail flick sniff iaculis. Suscipit shed everywhere libero suspendisse litter box, kittens nam run feed me ac egestas. Faucibus hiss claw adipiscing, orci turpis tincidunt a knock over the lamp lick enim accumsan. In viverra purr chase the red dot judging you egestas orci turpis, sleep in the sink nullam tail flick lick.</p>
</div>
  </body>
</html>